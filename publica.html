<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Publicações - DISET</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <img src="logo gdf.png" alt="Logo GDF">
    <h1>Gestão de Publicações</h1>
  </header>
  <main class="main-content">
    <div class="card">
      <h2 id="form-title">Cadastrar Nova Publicação</h2>
      <form id="publication-form">
        <input type="hidden" id="pub-doc-id" value="">
        <div class="form-group">
          <label for="pub-name">Nome da Publicação:</label>
          <input type="text" id="pub-name" required>
        </div>
        <div class="form-group">
          <label for="pub-type">Tipo de Documento:</label>
          <select id="pub-type" required>
            <option value="portarias">Portaria</option>
            <option value="leis">Lei</option>
            <option value="resolucoes">Resolução</option>
            <option value="outros">Outro Documento</option>
          </select>
        </div>
        <div class="form-group">
          <label for="pub-subject">Assunto:</label>
          <select id="pub-subject" required>
            <option value="remanejamento">Remanejamento</option>
            <option value="modulacao">Modulação</option>
            <option value="provimento">Provimento</option>
            <option value="outros">Outros</option>
          </select>
        </div>
        <div class="form-group">
          <label for="pub-file">Anexar Arquivo (em breve):</label>
          <input type="file" id="pub-file" disabled>
          <p class="file-info">O upload de arquivos será implementado em breve com o Firebase Storage.</p>
        </div>
        <div class="form-group">
          <button type="submit" id="save-button">Salvar Publicação</button>
          <button type="button" id="cancel-button" style="display:none;">Cancelar</button>
        </div>
      </form>

      <div class="message-box" id="message-box" style="display:none;"></div>

      <h2>Publicações Cadastradas</h2>
      <ul id="publications-list" class="gestao-list">
        <!-- Publicações serão carregadas aqui pelo Firestore -->
      </ul>

      <div class="loading-indicator" id="loading-indicator" style="display:block;">
        Carregando publicações...
      </div>
    </div>
  </main>
  <footer>
    <a href="index.html" class="botao-voltar">Voltar</a>
    <p>© 2025 - Secretaria de Estado de Educação do Distrito Federal (SEEDF) – DISET/SUGEP</p>
  </footer>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Firebase configuration
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';

    let db;
    let auth;
    let userId;

    async function initFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        await signInWithCustomToken(auth, initialAuthToken);
        userId = auth.currentUser?.uid;
        document.getElementById('loading-indicator').style.display = 'none';
        console.log("Firebase e Firestore inicializados com sucesso.");
        console.log(`Usuário logado com ID: ${userId}`);
        loadAndRenderPublications();
      } catch (error) {
        console.error("Erro ao inicializar Firebase:", error);
        showMessage("Erro ao conectar com o banco de dados. Tente novamente.", "error");
        document.getElementById('loading-indicator').textContent = "Erro ao carregar.";
      }
    }
    
    // Call the initialization function
    initFirebase();

    const publicationsForm = document.getElementById('publication-form');
    const publicationsList = document.getElementById('publications-list');
    const saveButton = document.getElementById('save-button');
    const cancelButton = document.getElementById('cancel-button');
    const formTitle = document.getElementById('form-title');
    const pubDocIdInput = document.getElementById('pub-doc-id');

    async function addOrUpdatePublication(e) {
      e.preventDefault();
      saveButton.disabled = true;
      
      const name = document.getElementById('pub-name').value;
      const type = document.getElementById('pub-type').value;
      const subject = document.getElementById('pub-subject').value;
      const docId = pubDocIdInput.value;

      try {
        const data = {
          name,
          type,
          subject,
          createdAt: new Date()
        };
        
        const publicationsRef = collection(db, `artifacts/${appId}/public/data/publications`);

        if (docId) {
          // Update existing document
          const docRef = doc(publicationsRef, docId);
          await setDoc(docRef, data);
          showMessage("Publicação atualizada com sucesso!", "success");
        } else {
          // Add new document
          await addDoc(publicationsRef, data);
          showMessage("Publicação adicionada com sucesso!", "success");
        }
        
        publicationsForm.reset();
        pubDocIdInput.value = "";
        saveButton.textContent = "Salvar Publicação";
        formTitle.textContent = "Cadastrar Nova Publicação";
        cancelButton.style.display = 'none';

      } catch (error) {
        console.error("Erro ao salvar a publicação:", error);
        showMessage("Erro ao salvar a publicação. Tente novamente.", "error");
      } finally {
        saveButton.disabled = false;
      }
    }

    async function deletePublication(docId) {
      const confirmDelete = window.confirm("Tem certeza que deseja excluir esta publicação?");
      if (!confirmDelete) return;

      try {
        const docRef = doc(db, `artifacts/${appId}/public/data/publications/${docId}`);
        await deleteDoc(docRef);
        showMessage("Publicação excluída com sucesso!", "success");
      } catch (error) {
        console.error("Erro ao excluir a publicação:", error);
        showMessage("Erro ao excluir a publicação. Tente novamente.", "error");
      }
    }

    function editPublication(docId, data) {
      document.getElementById('pub-name').value = data.name;
      document.getElementById('pub-type').value = data.type;
      document.getElementById('pub-subject').value = data.subject;
      pubDocIdInput.value = docId;
      saveButton.textContent = "Atualizar Publicação";
      formTitle.textContent = "Editar Publicação";
      cancelButton.style.display = 'inline-block';
    }

    function loadAndRenderPublications() {
      const publicationsRef = collection(db, `artifacts/${appId}/public/data/publications`);
      onSnapshot(publicationsRef, (querySnapshot) => {
        publicationsList.innerHTML = '';
        if (querySnapshot.empty) {
          publicationsList.innerHTML = '<p class="no-publications">Nenhuma publicação encontrada.</p>';
          return;
        }

        querySnapshot.forEach((doc) => {
          const pub = doc.data();
          const listItem = document.createElement('li');
          listItem.innerHTML = `
            <div>
              <strong>Nome:</strong> ${pub.name}<br>
              <strong>Tipo:</strong> ${pub.type}<br>
              <strong>Assunto:</strong> ${pub.subject}
            </div>
            <div class="actions">
              <button class="edit-button" data-doc-id="${doc.id}">Editar</button>
              <button class="delete-button" data-doc-id="${doc.id}">Excluir</button>
            </div>
          `;
          publicationsList.appendChild(listItem);
        });

        document.querySelectorAll('.edit-button').forEach(button => {
          button.addEventListener('click', () => {
            const docId = button.getAttribute('data-doc-id');
            const docData = querySnapshot.docs.find(d => d.id === docId).data();
            editPublication(docId, docData);
          });
        });

        document.querySelectorAll('.delete-button').forEach(button => {
          button.addEventListener('click', () => {
            const docId = button.getAttribute('data-doc-id');
            deletePublication(docId);
          });
        });
      });
    }

    function showMessage(message, type) {
      const messageBox = document.getElementById('message-box');
      messageBox.textContent = message;
      messageBox.className = `message-box ${type}`;
      messageBox.style.display = 'block';
      setTimeout(() => {
        messageBox.style.display = 'none';
      }, 5000);
    }
    
    publicationsForm.addEventListener('submit', addOrUpdatePublication);
    cancelButton.addEventListener('click', () => {
      publicationsForm.reset();
      pubDocIdInput.value = "";
      saveButton.textContent = "Salvar Publicação";
      formTitle.textContent = "Cadastrar Nova Publicação";
      cancelButton.style.display = 'none';
    });
  </script>
</body>
</html>
