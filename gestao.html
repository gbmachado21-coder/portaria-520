<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Publicações - DISET</title>
  <link rel="stylesheet" href="style.css">
  
  <script src="init_data.js"></script>
</head>
<body>
  <header>
    <img src="logo gdf.png" alt="Logo GDF">
    <h1>Gestão de Publicações</h1>
  </header>
  
  <main class="main-content">
    <div class="card">
      <h2 id="form-title">Cadastrar Nova Publicação</h2>
      <form id="publication-form">
        <input type="hidden" id="pub-index" value="-1">
        <div class="form-group">
          <label for="pub-name">Nome da Publicação:</label>
          <input type="text" id="pub-name" required>
        </div>
        <div class="form-group">
          <label for="pub-type">Tipo de Documento:</label>
          <select id="pub-type" required>
            <option value="portarias">Portaria</option>
            <option value="leis">Lei</option>
            <option value="resolucoes">Resolução</option>
            <option value="outros">Outro Documento</option>
          </select>
        </div>
        <div class="form-group">
          <label for="pub-subject">Assunto:</label>
          <select id="pub-subject" required>
            <option value="remanejamento">Remanejamento</option>
            <option value="modulacao">Modulação</option>
            <option value="provimento">Provimento</option>
          </select>
        </div>
        <div class="form-group">
          <label for="pub-file">Anexar Arquivo:</label>
          <input type="file" id="pub-file">
        </div>
        <div class="botoes-container">
          <button type="submit" id="save-button" class="botao">Salvar Publicação</button>
          <button type="button" id="cancel-button" class="botao-cancelar" style="display: none;">Cancelar Edição</button>
        </div>
      </form>
      <div id="message-box" class="message-box" style="display: none;"></div>
    </div>
    
    <div class="card publications-list-container">
      <h2>Publicações Cadastradas</h2>
      <ul id="publications-list">
        </ul>
    </div>
  </main>
  
  <footer>
    <nav class="back-button-container" aria-label="Navegação de Retorno">
      <a href="index.html" class="back-button">Voltar para a página inicial</a>
      <a href="publica.html" class="back-button">Ver Publicações</a>
    </nav>
    <p>© <time datetime="2025">2025</time> - Secretaria de Estado de Educação do Distrito Federal (SEEDF) – DISET/SUGEP</p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', loadAndRenderPublications);
    
    document.getElementById('publication-form').addEventListener('submit', function(event) {
      event.preventDefault();

      const name = document.getElementById('pub-name').value;
      const type = document.getElementById('pub-type').value;
      const subject = document.getElementById('pub-subject').value;
      const fileInput = document.getElementById('pub-file');
      const file = fileInput.files[0];
      const index = document.getElementById('pub-index').value;
      
      let publications = JSON.parse(localStorage.getItem('publicacoes')) || [];
      
      const newPublication = {
        name: name,
        type: type,
        subject: subject,
        // Mantém o nome do arquivo se estiver editando e nenhum novo arquivo for selecionado
        fileName: file ? file.name : (index !== "-1" ? publications[index].fileName : '')
      };

      try {
        if (index === "-1") {
          publications.push(newPublication);
          showMessage('Publicação salva com sucesso!', 'success');
        } else {
          publications[index] = newPublication;
          showMessage('Publicação atualizada com sucesso!', 'success');
          resetForm();
        }

        localStorage.setItem('publicacoes', JSON.stringify(publications));
        
        document.getElementById('publication-form').reset();
        loadAndRenderPublications();
      } catch (e) {
        showMessage('Erro ao salvar/atualizar a publicação. Tente novamente.', 'error');
        console.error('Erro ao salvar no localStorage:', e);
      }
    });

    document.getElementById('cancel-button').addEventListener('click', resetForm);

    function showMessage(text, type) {
      const messageBox = document.getElementById('message-box');
      messageBox.textContent = text;
      messageBox.style.display = 'block';
      
      messageBox.classList.remove('success', 'error', 'warning'); 

      // Configuração de estilo CSS (deve ser definido em style.css para ser ideal)
      if (type === 'success') {
        messageBox.classList.add('success');
        messageBox.style.backgroundColor = '#d4edda'; // Verde claro
        messageBox.style.color = '#155724'; // Texto verde escuro
      } else if (type === 'error') {
        messageBox.classList.add('error');
        messageBox.style.backgroundColor = '#f8d7da'; // Vermelho claro
        messageBox.style.color = '#721c24'; // Texto vermelho escuro
      } else if (type === 'warning') {
        messageBox.classList.add('warning');
        messageBox.style.backgroundColor = '#fff3cd'; // Amarelo claro
        messageBox.style.color = '#856404'; // Texto amarelo escuro
      }
      
      // Oculta a mensagem após 4 segundos
      setTimeout(() => {
        messageBox.style.display = 'none';
      }, 4000);
    }

    function resetForm() {
      document.getElementById('publication-form').reset();
      document.getElementById('pub-index').value = "-1";
      document.getElementById('save-button').textContent = "Salvar Publicação";
      document.getElementById('form-title').textContent = "Cadastrar Nova Publicação";
      document.getElementById('cancel-button').style.display = 'none';
    }

    function loadAndRenderPublications() {
      const publicationsList = document.getElementById('publications-list');
      publicationsList.innerHTML = '';
      const publications = JSON.parse(localStorage.getItem('publicacoes')) || [];

      if (publications.length === 0) {
          publicationsList.innerHTML = '<li class="no-data-message">Nenhuma publicação cadastrada.</li>';
          return;
      }

      publications.forEach((pub, index) => {
        const listItem = document.createElement('li');
        listItem.innerHTML = `
          <span>${pub.name} (${pub.type.toUpperCase()}, ${pub.subject.toUpperCase()}) - Arquivo: ${pub.fileName || 'Nenhum'}</span>
          <div class="actions">
            <button class="edit-button" data-index="${index}" title="Editar ${pub.name}">Editar</button>
            <button class="delete-button" data-index="${index}" title="Excluir ${pub.name}">Excluir</button>
          </div>
        `;
        publicationsList.appendChild(listItem);
      });

      // Adiciona o event listener aos botões de excluir
      document.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', function() {
          const index = this.getAttribute('data-index');
          if (confirm('Tem certeza que deseja excluir esta publicação? Esta ação é irreversível.')) {
            deletePublication(index);
          }
        });
      });

      // Adiciona o event listener aos botões de editar
      document.querySelectorAll('.edit-button').forEach(button => {
        button.addEventListener('click', function() {
          const index = this.getAttribute('data-index');
          editPublication(index);
        });
      });
    }

    function deletePublication(index) {
      let publications = JSON.parse(localStorage.getItem('publicacoes')) || [];
      if (index > -1) {
        publications.splice(index, 1);
        localStorage.setItem('publicacoes', JSON.stringify(publications));
        loadAndRenderPublications();
        showMessage('Publicação excluída com sucesso!', 'error'); // Usando 'error' para feedback de exclusão
        resetForm();
      }
    }

    function editPublication(index) {
      const publications = JSON.parse(localStorage.getItem('publicacoes')) || [];
      const pub = publications[index];
      
      document.getElementById('pub-name').value = pub.name;
      document.getElementById('pub-type').value = pub.type;
      document.getElementById('pub-subject').value = pub.subject;
      document.getElementById('pub-index').value = index;

      document.getElementById('save-button').textContent = "Atualizar Publicação";
      document.getElementById('form-title').textContent = "Editar Publicação";
      document.getElementById('cancel-button').style.display = 'inline-block';
      
      showMessage('Você está editando. O campo Arquivo não será preenchido. Selecione um novo arquivo se quiser alterá-lo.', 'warning'); 
    }
  </script>
</body>
</html>
