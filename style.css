<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Publicações - DISET</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <img src="logo gdf.png" alt="Logo GDF">
    <h1>Publicações e Legislação</h1>
  </header>
  <main class="main-content">
    <div class="card">
      <a href="gestao.html" class="include-button">Incluir Publicação</a>
      
      <div class="filter-container">
        <label for="document-filter">Filtrar por tipo de documento:</label>
        <select id="document-filter" onchange="applyFilters()">
          <option value="all">Todos</option>
          <option value="portarias">Portarias</option>
          <option value="leis">Leis</option>
          <option value="resolucoes">Resoluções</option>
          <option value="outros">Outros Documentos</option>
        </select>
        <label for="subject-filter">Filtrar por assunto:</label>
        <select id="subject-filter" onchange="applyFilters()">
          <option value="all">Todos</option>
          <option value="remanejamento">Remanejamento</option>
          <option value="concursos">Concursos</option>
          <option value="legislacao">Legislação</option>
          <option value="liderancas">Lideranças</option>
          <option value="recesso">Recesso</option>
          <option value="licenca">Licença</option>
          <option value="outro-assunto">Outro Assunto</option>
        </select>
      </div>

      <div id="publications-container">
        <!-- Publicações serão carregadas aqui -->
      </div>
      
      <div class="loading-indicator" id="loading-indicator" style="display:block;">
        Carregando publicações...
      </div>
    </div>
  </main>
  <footer>
    <div class="back-button-container">
      <a href="index.html" class="botao-voltar">Voltar para a página inicial</a>
      <a href="gestao.html" class="botao-voltar">Gerenciar Publicações</a>
    </div>
    <p>© 2025 - Secretaria de Estado de Educação do Distrito Federal (SEEDF) – DISET/SUGEP</p>
  </footer>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';

    let db;
    let auth;
    let allPublications = [];
    
    async function initFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        await signInWithCustomToken(auth, initialAuthToken);
        console.log("Firebase e Firestore inicializados com sucesso.");
        
        const publicationsRef = collection(db, `artifacts/${appId}/public/data/publications`);
        onSnapshot(publicationsRef, (querySnapshot) => {
          allPublications = querySnapshot.docs.map(doc => doc.data());
          document.getElementById('loading-indicator').style.display = 'none';
          renderPublications();
          applyFilters();
        });
      } catch (error) {
        console.error("Erro ao inicializar Firebase:", error);
        document.getElementById('loading-indicator').textContent = "Erro ao carregar as publicações.";
      }
    }

    window.onload = initFirebase;

    function renderPublications() {
      const container = document.getElementById('publications-container');
      container.innerHTML = '';

      if (allPublications.length === 0) {
        container.innerHTML = '<p class="no-publications">Nenhuma publicação encontrada.</p>';
        return;
      }
      
      const groupedPublications = allPublications.reduce((acc, pub) => {
        if (!acc[pub.type]) {
          acc[pub.type] = [];
        }
        acc[pub.type].push(pub);
        return acc;
      }, {});
      
      const typeNames = {
        'portarias': 'Portarias',
        'leis': 'Leis',
        'resolucoes': 'Resoluções',
        'outros': 'Outros Documentos'
      };

      for (const type in groupedPublications) {
        const group = document.createElement('div');
        group.className = 'publications-group';
        group.dataset.type = type;
        
        const header = document.createElement('div');
        header.className = 'group-header';
        header.innerHTML = `
          <span>${typeNames[type] || type}</span>
          <span class="group-toggle-icon">></span>
        `;
        
        const list = document.createElement('ul');
        list.className = 'group-list';
        
        groupedPublications[type].forEach(pub => {
          const listItem = document.createElement('li');
          listItem.dataset.subject = pub.subject;
          const link = document.createElement('a');
          link.href = '#'; // Link temporário
          link.textContent = `${pub.name} (${pub.subject})`;
          listItem.appendChild(link);
          list.appendChild(listItem);
        });
        
        group.appendChild(header);
        group.appendChild(list);
        container.appendChild(group);

        header.addEventListener('click', () => {
          group.classList.toggle('open');
        });
      }
    }

    function applyFilters() {
      const docType = document.getElementById('document-filter').value;
      const subject = document.getElementById('subject-filter').value;

      const allGroups = document.querySelectorAll('.publications-group');
      
      allGroups.forEach(group => {
        if (docType === 'all' || group.dataset.type === docType) {
          group.style.display = 'block';
        } else {
          group.style.display = 'none';
        }
      });

      const allItems = document.querySelectorAll('.publications-group li');
      allItems.forEach(item => {
        const itemIsVisibleByType = item.closest('.publications-group').style.display !== 'none';
        
        if (itemIsVisibleByType) {
          if (subject === 'all' || item.dataset.subject === subject) {
            item.style.display = 'list-item';
          } else {
            item.style.display = 'none';
          }
        } else {
            item.style.display = 'none';
        }
      });
    }

    window.applyFilters = applyFilters;
  </script>
</body>
</html>
